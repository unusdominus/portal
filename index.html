<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unus Dominus - Portal Católico</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-left-color: #fff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app" class="max-w-7xl mx-auto p-4 md:p-6">

        <!-- 1. CABEÇALHO E NAVEGAÇÃO -->
        <header class="bg-white shadow-md rounded-lg p-6 mb-6">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <h1 class="text-3xl font-bold text-yellow-700">UNUS DOMINUS</h1>
                <nav class="mt-4 md:mt-0">
                    <button id="parish-login-button" class="bg-yellow-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-yellow-700 transition duration-200">
                        Acesso da Paróquia
                    </button>
                </nav>
            </div>
        </header>

        <!-- 2. CONTEÚDO PRINCIPAL (SITE PÚBLICO) -->
        <main id="public-site" class="space-y-6">

            <!-- 2.1. DESTAQUE PRINCIPAL E MURAL DIOCESANO -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Destaque Principal (2/3) -->
                <div id="destaque-loading" class="md:col-span-2 bg-white shadow-lg rounded-lg p-6 animate-pulse h-96 flex items-center justify-center">Carregando destaques...</div>
                <div id="destaque-content" class="md:col-span-2 bg-white shadow-lg rounded-lg overflow-hidden hidden">
                    <!-- Conteúdo será preenchido pelo JavaScript -->
                </div>

                <!-- Mural Diocesano (1/3) -->
                <div id="mural-loading" class="bg-white shadow-lg rounded-lg p-6 animate-pulse h-96 flex items-center justify-center">Carregando mural...</div>
                <div id="mural-content" class="bg-white shadow-lg rounded-lg overflow-hidden hidden">
                    <div class="p-6">
                        <h2 class="text-2xl font-bold text-yellow-700 mb-4">Mural Diocesano</h2>
                        <!-- Abas do Mural -->
                        <div class="border-b border-gray-200">
                            <nav class="-mb-px flex space-x-4" aria-label="Tabs">
                                <button class="tab-button active" data-tab="liturgia">Liturgia</button>
                                <button class="tab-button" data-tab="santo">Santo do Dia</button>
                                <button class="tab-button" data-tab="eventos">Eventos</button>
                            </nav>
                        </div>
                        <!-- Conteúdo das Abas -->
                        <div id="mural-tabs-content" class="mt-4">
                            <!-- Liturgia -->
                            <div id="tab-liturgia" class="tab-content active space-y-2">
                                <!-- Conteúdo preenchido pelo JavaScript -->
                            </div>
                            <!-- Santo do Dia -->
                            <div id="tab-santo" class="tab-content space-y-2">
                                <!-- Conteúdo preenchido pelo JavaScript -->
                            </div>
                            <!-- Eventos/Festas -->
                            <div id="tab-eventos" class="tab-content space-y-4">
                                <div>
                                    <h4 class="font-semibold text-gray-700">Festividades da Semana</h4>
                                    <ul id="festividades-list" class="list-disc list-inside text-sm text-gray-600"></ul>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-700">Anúncios</h4>
                                    <ul id="anuncios-list" class="list-disc list-inside text-sm text-gray-600"></ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2.2. BUSCA E LISTA DE PARÓQUIAS -->
            <div class="bg-white shadow-lg rounded-lg p-6">
                <h2 class="text-2xl font-bold text-yellow-700 mb-4">Encontre sua Paróquia</h2>
                <input id="search-input" type="text" placeholder="Buscar paróquia por nome, bairro ou cidade..." class="w-full p-3 border border-gray-300 rounded-lg">
                
                <div id="parishes-loading" class="mt-4 text-center text-gray-500">
                    <div class="loading-spinner inline-block" style="border-left-color: #b45309;"></div>
                    <span class="ml-2">Carregando paróquias...</span>
                </div>
                
                <div id="parishes-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mt-6">
                    <!-- Paróquias serão preenchidas pelo JavaScript -->
                </div>
            </div>

        </main>

        <!-- 3. MODAL DE LOGIN (Oculto por padrão) -->
        <div id="login-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center p-4 hidden">
            <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md">
                <h2 class="text-2xl font-bold text-center text-yellow-700 mb-6">Acesso Paroquial</h2>
                <div id="login-error" class="text-red-500 text-sm mb-4 hidden"></div>
                <form id="login-form">
                    <div class="mb-4">
                        <label for="login-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" id="login-email" class="w-full p-2 border border-gray-300 rounded-lg" required>
                    </div>
                    <div class="mb-6">
                        <label for="login-password" class="block text-sm font-medium text-gray-700 mb-1">Senha</label>
                        <input type="password" id="login-password" class="w-full p-2 border border-gray-300 rounded-lg" required>
                    </div>
                    <button type="submit" id="login-submit-button" class="w-full bg-yellow-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-yellow-700 transition duration-200 flex items-center justify-center">
                        <span class="button-text">Entrar</span>
                        <div class="loading-spinner hidden"></div>
                    </button>
                    <button type="button" id="login-cancel-button" class="w-full bg-gray-200 text-gray-700 py-2 px-4 rounded-lg font-semibold hover:bg-gray-300 transition duration-200 mt-3">
                        Cancelar
                    </button>
                </form>
            </div>
        </div>

        <!-- 4. PAINEL DE ADMINISTRAÇÃO (Oculto por padrão, substitui o site público) -->
        <div id="admin-panel" class="bg-white shadow-lg rounded-lg p-6 md:p-8 hidden">
            <!-- Conteúdo do Painel de Admin será preenchido pelo JavaScript -->
        </div>

    </div>

    <!-- 5. MODAL DE DETALHES DA PARÓQUIA (Oculto por padrão) -->
    <div id="parish-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center p-4 hidden overflow-y-auto">
        <div id="parish-modal-content" class="bg-white rounded-lg shadow-xl w-full max-w-3xl max-h-[90vh] overflow-y-auto">
            <!-- Conteúdo do Modal da Paróquia será preenchido pelo JavaScript -->
        </div>
    </div>


    <!-- ====================================================================== -->
    <!-- SCRIPT (LÓGICA DO SITE) -->
    <!-- ====================================================================== -->

    <!-- --- 1. BIBLIOTECAS EXTERNAS --- -->
    
    <!-- Firebase Core (Obrigatório) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
    
    <!-- Firebase Firestore (Banco de Dados) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"></script>
    
    <!-- Firebase Authentication (Login) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js"></script>
    

    <script type="module">
        // --- 2. IMPORTAÇÕES DOS MÓCULOS FIREBASE ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { 
            getFirestore, collection, doc, getDoc, getDocs, onSnapshot,
            query, where, updateDoc
        } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
        import { 
            getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut 
        } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";

        // --- 3. CONFIGURAÇÃO DO FIREBASE ---
        // ATENÇÃO: SUBSTITUA COM AS SUAS CHAVES REAIS DO FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyCN8Wm-XqTkD4tcjlF-tTusRO92JA0c0Y0",
            authDomain: "unusdominus.firebaseapp.com",
            projectId: "unusdominus",
            storageBucket: "unusdominus.firebasestorage.app",
            messagingSenderId: "1040204777601",
            appId: "1:1040204777601:web:577008a19a846bc0462580",
            measurementId: "G-FEDJMGTLRD"
        };
        // --- FIM DA CONFIGURAÇÃO OBRIGATÓRIA ---


        // --- 4. INICIALIZAÇÃO DO APP E SERVIÇOS ---
        let app, db, auth;
        let parishesCache = []; // Cache local para busca rápida
        let currentAdminParishId = null; // ID da paróquia que o admin está editando

        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
            console.log("Firebase inicializado com sucesso!");
        } catch (error) {
            console.error("Erro ao inicializar o Firebase:", error);
            document.body.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded m-4" role="alert">
                <strong class="font-bold">Erro de Configuração!</strong>
                <span class="block sm:inline">Não foi possível conectar ao Firebase. Verifique se o objeto 'firebaseConfig' está correto no seu código index.html.</span>
            </div>`;
        }


        // --- 5. LÓGICA DO SITE PÚBLICO ---

        // Função para carregar o conteúdo global (Destaque, Mural, etc.)
        async function loadGlobalContent() {
            try {
                const docRef = doc(db, "globalContent", "main");
                
                // Usar onSnapshot para ouvir mudanças em tempo real (atualiza o site sem refresh)
                onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        
                        // Renderiza Destaque
                        const destaqueContainer = document.getElementById("destaque-content");
                        if (data?.destaquePrincipal) {
                            destaqueContainer.innerHTML = `
                                <img src="${data.destaquePrincipal.imagemUrl || 'https://placehold.co/800x400/c2b280/FFFFFF?text=Destaque'}" alt="${data.destaquePrincipal.titulo}" class="w-full h-64 object-cover">
                                <div class="p-6">
                                    <h3 class="text-xl font-bold mb-2">${data.destaquePrincipal.titulo}</h3>
                                    <p class="text-gray-600">${data.destaquePrincipal.descricao}</p>
                                </div>
                            `;
                            document.getElementById("destaque-loading").style.display = 'none';
                            destaqueContainer.classList.remove("hidden");
                        }
                        
                        // Renderiza Mural
                        const muralContainer = document.getElementById("mural-content");
                        
                        // Liturgia
                        if (data?.liturgiaDiaria) {
                            const liturgia = data.liturgiaDiaria;
                            document.getElementById("tab-liturgia").innerHTML = `
                                <h4 class="font-semibold text-gray-700">${liturgia.data || 'Leituras do Dia'}</h4>
                                <div class="text-sm text-gray-600 mt-2">
                                    <p><strong>1ª Leitura:</strong> ${liturgia.primeiraLeitura?.ref || ''} - ${liturgia.primeiraLeitura?.texto ? liturgia.primeiraLeitura.texto.substring(0, 100) + '...' : ''}</p>
                                    <p><strong>Salmo:</strong> ${liturgia.salmo?.ref || ''}</p>
                                    <p><strong>Evangelho:</strong> ${liturgia.evangelho?.ref || ''} - ${liturgia.evangelho?.texto ? liturgia.evangelho.texto.substring(0, 100) + '...' : ''}</p>
                                </div>
                            `;
                        } else {
                             document.getElementById("tab-liturgia").innerHTML = '<p class="text-sm text-gray-500">Liturgia não disponível.</p>';
                        }

                        // Santo do Dia
                        if (data?.santoDoDia) {
                            const santo = data.santoDoDia;
                            document.getElementById("tab-santo").innerHTML = `
                                <img src="${santo.imagemUrl || 'https://placehold.co/300x200/c2b280/FFFFFF?text=Santo'}" alt="${santo.nome}" class="w-full h-32 object-cover rounded-lg mb-2">
                                <h4 class="font-semibold text-gray-700">${santo.nome}</h4>
                                <p class="text-sm text-gray-600">${santo.bio ? santo.bio.substring(0, 150) + '...' : ''}</p>
                            `;
                        } else {
                             document.getElementById("tab-santo").innerHTML = '<p class="text-sm text-gray-500">Santo do dia não disponível.</p>';
                        }

                        // Eventos
                        const festasList = document.getElementById("festividades-list");
                        festasList.innerHTML = '';
                        if (data?.festividadesSemana?.length > 0) {
                            data.festividadesSemana.forEach(f => {
                                festasList.innerHTML += `<li><strong>${f.dia}:</strong> ${f.evento}</li>`;
                            });
                        } else {
                            festasList.innerHTML = '<li>Nenhuma festividade cadastrada.</li>';
                        }

                        const anunciosList = document.getElementById("anuncios-list");
                        anunciosList.innerHTML = '';
                        if (data?.anuncios?.length > 0) {
                            data.anuncios.forEach(a => {
                                anunciosList.innerHTML += `<li><strong>${a.titulo}:</strong> ${a.descricao}</li>`;
                            });
                        } else {
                            anunciosList.innerHTML = '<li>Nenhum anúncio cadastrado.</li>';
                        }

                        document.getElementById("mural-loading").style.display = 'none';
                        muralContainer.classList.remove("hidden");

                    } else {
                        console.log("Documento global 'main' não encontrado!");
                        document.getElementById("destaque-loading").innerText = "Conteúdo não encontrado.";
                        document.getElementById("mural-loading").innerText = "Conteúdo não encontrado.";
                    }
                }, (error) => {
                     console.error("Erro ao carregar dados globais do Firestore: ", error);
                     // Se o erro for de permissão, o F12 mostrará
                });
            } catch (error) {
                console.error("Erro ao carregar conteúdo global:", error);
            }
        }

        // Função para carregar todas as paróquias
        async function loadParishes() {
            try {
                const parishesCollection = collection(db, "parishes");
                const q = query(parishesCollection); // Pode-se adicionar filtros aqui depois
                
                // Usar onSnapshot para atualizar a lista de paróquias em tempo real
                onSnapshot(q, (querySnapshot) => {
                    parishesCache = []; // Limpa o cache
                    const listElement = document.getElementById("parishes-list");
                    listElement.innerHTML = ''; // Limpa a lista atual
                    
                    if (querySnapshot.empty) {
                        listElement.innerHTML = '<p class="text-gray-500 col-span-full">Nenhuma paróquia cadastrada ainda.</p>';
                    }

                    querySnapshot.forEach((doc) => {
                        const parish = { id: doc.id, ...doc.data() };
                        parishesCache.push(parish); // Adiciona ao cache
                        
                        const card = `
                            <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden cursor-pointer hover:shadow-md transition-shadow" data-parish-id="${parish.id}">
                                <img src="${parish.fotoUrl || 'https://placehold.co/400x250/c2b280/FFFFFF?text=Igreja'}" alt="${parish.nome}" class="w-full h-48 object-cover">
                                <div class="p-4">
                                    <h3 class="text-lg font-semibold text-yellow-700">${parish.nome}</h3>
                                    <p class="text-sm text-gray-500 truncate">${parish.endereco || 'Endereço não informado'}</p>
                                </div>
                            </div>
                        `;
                        listElement.innerHTML += card;
                    });
                    
                    document.getElementById("parishes-loading").style.display = 'none';
                }, (error) => {
                    console.error("Erro ao carregar paróquias do Firestore: ", error);
                    document.getElementById("parishes-loading").innerText = "Erro ao carregar paróquias.";
                });
            } catch (error)
 {
                console.error("Erro ao carregar paróquias:", error);
            }
        }

        // Função para filtrar paróquias (usa o cache local)
        function filterParishes() {
            const searchTerm = document.getElementById("search-input").value.toLowerCase();
            const listElement = document.getElementById("parishes-list");
            listElement.innerHTML = '';
            
            const filtered = parishesCache.filter(p => 
                p.nome.toLowerCase().includes(searchTerm) ||
                (p.endereco && p.endereco.toLowerCase().includes(searchTerm))
            );

            if (filtered.length === 0) {
                listElement.innerHTML = '<p class="text-gray-500 col-span-full">Nenhuma paróquia encontrada com este termo.</p>';
                return;
            }

            filtered.forEach(parish => {
                const card = `
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden cursor-pointer hover:shadow-md transition-shadow" data-parish-id="${parish.id}">
                        <img src="${parish.fotoUrl || 'https://placehold.co/400x250/c2b280/FFFFFF?text=Igreja'}" alt="${parish.nome}" class="w-full h-48 object-cover">
                        <div class="p-4">
                            <h3 class="text-lg font-semibold text-yellow-700">${parish.nome}</h3>
                            <p class="text-sm text-gray-500 truncate">${parish.endereco || 'Endereço não informado'}</p>
                        </div>
                    </div>
                `;
                listElement.innerHTML += card;
            });
        }
        
        // Função para mostrar o modal de detalhes da paróquia
        function showParishDetails(parishId) {
            const parish = parishesCache.find(p => p.id === parishId);
            if (!parish) return;

            const modal = document.getElementById("parish-modal");
            const content = document.getElementById("parish-modal-content");
            
            let missasHtml = '<li>Nenhum horário cadastrado.</li>';
            if (parish.missas?.length > 0) {
                missasHtml = parish.missas.map(m => `<li><span class="font-semibold">${m.dia}:</span> ${m.horarios}</li>`).join('');
            }

            let avisosHtml = '<li>Nenhum aviso cadastrado.</li>';
            if (parish.avisos?.length > 0) {
                avisosHtml = parish.avisos.map(a => `
                    <div class="bg-gray-50 border-l-4 border-yellow-600 p-4 mb-2 rounded-r-lg">
                        <h4 class="font-semibold">${a.titulo} (${a.data})</h4>
                        <p class="text-sm">${a.descricao}</p>
                    </div>
                `).join('');
            }

            content.innerHTML = `
                <img src="${parish.fotoUrl || 'https://placehold.co/600x300/c2b280/FFFFFF?text=Igreja'}" alt="${parish.nome}" class="w-full h-64 object-cover rounded-t-lg">
                <div class="p-6 space-y-4">
                    <h2 class="text-2xl font-bold text-yellow-700">${parish.nome}</h2>
                    <p class="text-gray-600 italic">Pároco: ${parish.paroco || 'Não informado'}</p>
                    
                    <div class="border-t pt-4">
                        <h3 class="text-lg font-semibold mb-2">Informações</h3>
                        <p>${parish.endereco || 'Endereço não informado'}</p>
                        <p>${parish.telefone || 'Telefone não informado'}</p>
                        <p>${parish.email || 'Email não informado'}</p>
                    </div>
                    
                    <div class="border-t pt-4">
                        <h3 class="text-lg font-semibold mb-2">Horários das Missas</h3>
                        <ul class="list-disc list-inside space-y-1">${missasHtml}</ul>
                    </div>
                    
                    <div class="border-t pt-4">
                        <h3 class="text-lg font-semibold mb-2">Confissões</h3>
                        <p>${parish.confissoes || 'Não informado'}</p>
                    </div>

                    <div class="border-t pt-4">
                        <h3 class="text-lg font-semibold mb-2">Mural de Avisos</h3>
                        ${avisosHtml}
                    </div>

                    <button id="parish-modal-close" class="w-full bg-gray-200 text-gray-700 py-2 px-4 rounded-lg font-semibold hover:bg-gray-300 transition duration-200 mt-4">
                        Fechar
                    </button>
                </div>
            `;
            modal.classList.remove('hidden');
        }


        // --- 6. LÓGICA DE AUTENTICAÇÃO E PAINEL ADMIN ---
        
        // Monitora o estado de autenticação
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Usuário está logado
                console.log("Usuário logado:", user.uid);
                showAdminPanel(user);
            } else {
                // Usuário está deslogado
                console.log("Usuário deslogado.");
                showPublicSite();
            }
        });

        // Mostra o Modal de Login
        document.getElementById("parish-login-button").addEventListener("click", () => {
            document.getElementById("login-modal").classList.remove("hidden");
        });

        // Cancela o Login
        document.getElementById("login-cancel-button").addEventListener("click", () => {
            document.getElementById("login-modal").classList.add("hidden");
            document.getElementById("login-error").classList.add("hidden");
            document.getElementById("login-form").reset();
        });

        // Processa o formulário de login
        document.getElementById("login-form").addEventListener("submit", async (e) => {
            e.preventDefault();
            const email = document.getElementById("login-email").value;
            const password = document.getElementById("login-password").value;
            const errorDiv = document.getElementById("login-error");
            const submitButton = document.getElementById("login-submit-button");

            submitButton.querySelector('.button-text').classList.add('hidden');
            submitButton.querySelector('.loading-spinner').classList.remove('hidden');
            submitButton.disabled = true;

            try {
                await signInWithEmailAndPassword(auth, email, password);
                // Sucesso! O onAuthStateChanged vai ser disparado
                document.getElementById("login-modal").classList.add("hidden");
                errorDiv.classList.add("hidden");
                document.getElementById("login-form").reset();
            } catch (error) {
                console.error("Erro de login:", error.code);
                errorDiv.innerText = "Email ou senha inválidos. Tente novamente.";
                errorDiv.classList.remove("hidden");
            } finally {
                submitButton.querySelector('.button-text').classList.remove('hidden');
                submitButton.querySelector('.loading-spinner').classList.add('hidden');
                submitButton.disabled = false;
            }
        });

        // Mostra o Painel de Admin para o usuário logado
        async function showAdminPanel(user) {
            try {
                // Descobre qual paróquia este usuário administra
                const q = query(collection(db, "parishes"), where("ownerUid", "==", user.uid));
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    alert("Erro: Seu usuário não está associado a nenhuma paróquia.");
                    await signOut(auth);
                    return;
                }

                const parishDoc = querySnapshot.docs[0];
                const parish = { id: parishDoc.id, ...parishDoc.data() };
                currentAdminParishId = parish.id; // Salva o ID da paróquia

                // Esconde o site público e mostra o painel
                document.getElementById("public-site").style.display = 'none';
                document.getElementById("parish-login-button").innerText = 'Sair';
                document.getElementById("admin-panel").classList.remove("hidden");
                
                renderAdminPanel(parish, user.email);

            } catch (error) {
                console.error("Erro ao buscar dados do admin:", error);
                alert("Erro ao carregar seus dados. Tente fazer login novamente.");
                await signOut(auth);
            }
        }
        
        // Renderiza o HTML do Painel de Admin
        function renderAdminPanel(parish, userEmail) {
            const panel = document.getElementById("admin-panel");
            
            // Converte arrays em campos de texto simples
            const missasText = (parish.missas || []).map(m => `${m.dia}: ${m.horarios}`).join('\n');
            const avisosText = (parish.avisos || []).map(a => `${a.data} | ${a.titulo} | ${a.descricao}`).join('\n');

            panel.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-yellow-700">Painel da ${parish.nome}</h2>
                        <p class="text-gray-500">Logado como: ${userEmail}</p>
                    </div>
                    <button id="admin-logout-button" class="bg-red-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-red-700 transition duration-200">
                        Sair
                    </button>
                </div>

                <form id="admin-form" class="space-y-6">
                    
                    <!-- Informações Básicas -->
                    <div class="border-b pb-6">
                        <h3 class="text-lg font-semibold mb-2">Informações Básicas</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium">Pároco</label>
                                <input type="text" id="admin-paroco" value="${parish.paroco || ''}" class="w-full p-2 border border-gray-300 rounded-lg mt-1">
                            </div>
                            <div>
                                <label class="block text-sm font-medium">Telefone</label>
                                <input type="text" id="admin-telefone" value="${parish.telefone || ''}" class="w-full p-2 border border-gray-300 rounded-lg mt-1">
                            </div>
                            <div>
                                <label class="block text-sm font-medium">Email</label>
                                <input type="email" id="admin-email" value="${parish.email || ''}" class="w-full p-2 border border-gray-300 rounded-lg mt-1">
                            </div>
                            <div>
                                <label class="block text-sm font-medium">Endereço</label>
                                <input type="text" id="admin-endereco" value="${parish.endereco || ''}" class="w-full p-2 border border-gray-300 rounded-lg mt-1" readonly disabled title="Endereço não pode ser alterado por aqui">
                            </div>
                        </div>
                    </div>

                    <!-- Horários -->
                    <div class="border-b pb-6">
                        <h3 class="text-lg font-semibold mb-2">Horários de Missa</h3>
                        <textarea id="admin-missas" rows="5" class="w-full p-2 border border-gray-300 rounded-lg mt-1 font-mono" placeholder="Formato: Dia: Horários (um por linha)&#10;Ex: Domingo: 07:00, 09:00&#10;Ex: Segunda a Sexta: 19:00">${missasText}</textarea>
                        
                        <label class="block text-sm font-medium mt-4">Horários de Confissão</label>
                        <input type="text" id="admin-confissoes" value="${parish.confissoes || ''}" class="w-full p-2 border border-gray-300 rounded-lg mt-1">
                    </div>

                    <!-- Avisos -->
                    <div class="border-b pb-6">
                        <h3 class="text-lg font-semibold mb-2">Mural de Avisos</h3>
                        <textarea id="admin-avisos" rows="5" class="w-full p-2 border border-gray-300 rounded-lg mt-1 font-mono" placeholder="Formato: DD/MM | Título | Descrição (um por linha)&#10;Ex: 15/08 | Festa do Padroeiro | ...">${avisosText}</textarea>
                    </div>

                    <!-- Imagem da Paróquia (Cloudinary) -->
                    <div class="border-b pb-6">
                        <h3 class="text-lg font-semibold mb-2">Foto da Paróquia</h3>
                        <p class="text-sm text-gray-500 mb-2">Para alterar, escolha uma nova foto abaixo. A imagem antiga será substituída.</p>
                        <div class="flex items-center space-x-4">
                            <img src="${parish.fotoUrl || 'https://placehold.co/100x100/c2b280/FFFFFF?text=Sem+Foto'}" alt="Foto atual" class="w-24 h-24 object-cover rounded-lg border">
                            <input type="file" id="admin-foto" accept="image/png, image/jpeg">
                        </div>
                    </div>

                    <!-- Salvar -->
                    <div id="admin-save-feedback" class="h-10"></div>
                    <button type="submit" id="admin-save-button" class="w-full bg-green-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-green-700 transition duration-200 flex items-center justify-center">
                        <span class="button-text">Salvar Alterações</span>
                        <div class="loading-spinner hidden"></div>
                    </button>
                </form>
            `;
            
            // Adiciona evento de logout
            document.getElementById("admin-logout-button").addEventListener("click", async () => {
                if (confirm("Tem certeza que deseja sair do painel?")) {
                    await signOut(auth);
                }
            });

            // Adiciona evento de salvar
            document.getElementById("admin-form").addEventListener("submit", handleSaveChanges);
        }

        // Função para Salvar as Mudanças do Admin (Com Upload para Cloudinary)
        async function handleSaveChanges(e) {
            e.preventDefault();
            
            const saveButton = document.getElementById("admin-save-button");
            const feedbackDiv = document.getElementById("admin-save-feedback");

            // Mostrar loading
            saveButton.querySelector('.button-text').classList.add('hidden');
            saveButton.querySelector('.loading-spinner').classList.remove('hidden');
            saveButton.disabled = true;
            feedbackDiv.innerHTML = '<p class="text-blue-600">Salvando, por favor aguarde...</p>';

            try {
                let newFotoUrl = null;
                const fileInput = document.getElementById("admin-foto");

                // ETAPA 1: Upload da Imagem (se houver)
                if (fileInput.files[0]) {
                    console.log("Iniciando upload para o Cloudinary...");
                    
                    // --- CONFIGURAÇÃO DO CLOUDINARY ---
                    // ATENÇÃO: SUBSTITUA COM SEUS DADOS REAIS DO CLOUDINARY
                    const CLOUDINARY_CLOUD_NAME = "dmmj5gp1";
                    const CLOUDINARY_UPLOAD_PRESET = "ml_default";
                    // --- FIM DA CONFIGURAÇÃO OBRIGATÓRIA ---

                    if (CLOUDINARY_CLOUD_NAME === "COLE_SEU_CLOUD_NAME_AQUI") {
                        throw new Error("Cloudinary não configurado. Adicione seu Cloud Name e Upload Preset.");
                    }

                    const formData = new FormData();
                    formData.append('file', fileInput.files[0]);
                    formData.append('upload_preset', CLOUDINARY_UPLOAD_PRESET);
                    
                    feedbackDiv.innerHTML = '<p class="text-blue-600">Enviando imagem...</p>';

                    const uploadResponse = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, {
                        method: 'POST',
                        body: formData
                    });

                    if (!uploadResponse.ok) {
                        throw new Error("Falha no upload da imagem.");
                    }

                    const uploadResult = await uploadResponse.json();
                    newFotoUrl = uploadResult.secure_url; // URL da imagem no Cloudinary
                    console.log("Upload da imagem concluído:", newFotoUrl);
                }

                // ETAPA 2: Preparar Dados do Formulário
                feedbackDiv.innerHTML = '<p class="text-blue-600">Atualizando banco de dados...</p>';

                // Processa Missas
                const missasText = document.getElementById("admin-missas").value.trim();
                const missasArray = missasText.split('\n')
                    .filter(line => line.includes(':'))
                    .map(line => {
                        const parts = line.split(':');
                        return {
                            dia: parts[0].trim(),
                            horarios: parts.slice(1).join(':').trim()
                        };
                    });
                
                // Processa Avisos
                const avisosText = document.getElementById("admin-avisos").value.trim();
                const avisosArray = avisosText.split('\n')
                    .filter(line => line.includes('|'))
                    .map(line => {
                        const parts = line.split('|');
                        return {
                            data: (parts[0] || 'Sem data').trim(),
                            titulo: (parts[1] || 'Sem título').trim(),
                            descricao: (parts[2] || 'Sem descrição').trim()
                        };
                    });

                // Cria o objeto de atualização
                const dataToUpdate = {
                    paroco: document.getElementById("admin-paroco").value,
                    telefone: document.getElementById("admin-telefone").value,
                    email: document.getElementById("admin-email").value,
                    confissoes: document.getElementById("admin-confissoes").value,
                    missas: missasArray,
                    avisos: avisosArray,
                };

                // Adiciona a nova foto APENAS se o upload foi feito
                if (newFotoUrl) {
                    dataToUpdate.fotoUrl = newFotoUrl;
                }

                // ETAPA 3: Salvar no Firestore
                const docRef = doc(db, "parishes", currentAdminParishId);
                await updateDoc(docRef, dataToUpdate);

                // Sucesso!
                feedbackDiv.innerHTML = '<p class="text-green-600 font-semibold">Alterações salvas com sucesso!</p>';
                
                // Atualiza a imagem no painel de admin se ela foi alterada
                if (newFotoUrl) {
                    document.querySelector("#admin-panel img").src = newFotoUrl;
                }
                
                // Limpa o feedback após 3 segundos
                setTimeout(() => { feedbackDiv.innerHTML = ''; }, 3000);

            } catch (error) {
                console.error("Erro ao salvar alterações:", error);
                feedbackDiv.innerHTML = `<p class="text-red-600 font-semibold">Erro ao salvar: ${error.message}</p>`;
            } finally {
                // Restaurar o botão
                saveButton.querySelector('.button-text').classList.remove('hidden');
                saveButton.querySelector('.loading-spinner').classList.add('hidden');
                saveButton.disabled = false;
            }
        }

        // Mostra o site público (ao deslogar)
        function showPublicSite() {
            document.getElementById("public-site").style.display = 'block';
            document.getElementById("admin-panel").classList.add("hidden");
            document.getElementById("admin-panel").innerHTML = ""; // Limpa o painel
            document.getElementById("parish-login-button").innerText = 'Acesso da Paróquia';
            currentAdminParishId = null;
        }

        // --- 7. EVENT LISTENERS (Gatilhos de Interação) ---

        // Listener da barra de busca
        document.getElementById("search-input").addEventListener("keyup", filterParishes);

        // Listener de clique nas abas do Mural
        document.querySelectorAll(".tab-button").forEach(button => {
            button.addEventListener("click", () => {
                const tabId = button.dataset.tab;
                
                // Remove 'active' de todos
                document.querySelectorAll(".tab-button").forEach(btn => btn.classList.remove("active"));
                document.querySelectorAll(".tab-content").forEach(content => content.classList.remove("active"));

                // Adiciona 'active' ao clicado
                button.classList.add("active");
                document.getElementById(`tab-${tabId}`).classList.add("active");
            });
        });

        // Listener para abrir o modal de detalhes (clicando no card da paróquia)
        document.getElementById("parishes-list").addEventListener("click", (e) => {
            const card = e.target.closest('[data-parish-id]');
            if (card) {
                showParishDetails(card.dataset.parishId);
            }
        });

        // Listener para fechar o modal de detalhes
        document.getElementById("parish-modal").addEventListener("click", (e) => {
            // Fecha se clicar no fundo ou no botão "Fechar"
            if (e.target.id === "parish-modal" || e.target.id === "parish-modal-close") {
                document.getElementById("parish-modal").classList.add("hidden");
                document.getElementById("parish-modal-content").innerHTML = ""; // Limpa o conteúdo
            }
        });

        // --- 8. INICIALIZAÇÃO DA PÁGINA ---
        
        // Verifica se os serviços do Firebase estão prontos antes de carregar os dados
        if (db && auth) {
            loadGlobalContent();
            loadParishes();
        }

    </script>
</body>
</html>

