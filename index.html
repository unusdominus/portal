<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unus Dominus - Portal Cat√≥lico</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
        }
        .loading-spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-left-color: #fff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        /* Spinner do Novo Mural */
        .mural-spinner {
            width: 24px;
            height: 24px;
            border: 4px solid rgba(180, 83, 9, 0.2); /* Amarelo mais claro */
            border-top-color: #b45309; /* Amarelo principal */
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Estilos do Carrossel */
        .carousel-container {
            position: relative;
            overflow: hidden;
        }
        .carousel-track {
            display: flex;
            transition: transform 0.5s ease-in-out;
        }
        .carousel-slide {
            flex: 0 0 100%;
            min-width: 100%;
            position: relative;
        }
        .carousel-dots {
            position: absolute;
            bottom: 16px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
        }
        .carousel-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .carousel-dot.active {
            background-color: rgba(255, 255, 255, 1);
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app" class="max-w-7xl mx-auto p-4 md:p-6">

        <!-- 1. CABE√áALHO E NAVEGA√á√ÉO -->
        <header class="bg-white shadow-md rounded-lg p-6 mb-6">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <h1 class="text-3xl font-bold text-yellow-700">UNUS DOMINUS</h1>
                <nav class="mt-4 md:mt-0">
                    <button id="parish-login-button" class="bg-yellow-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-yellow-700 transition duration-200">
                        Acesso Restrito
                    </button>
                </nav>
            </div>
        </header>

        <!-- 2. CONTE√öDO PRINCIPAL (SITE P√öBLICO) -->
        <main id="public-site" class="space-y-6">

            <!-- 2.1. CARROSSEL DE DESTAQUES E MURAL DIOCESANO -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                
                <!-- Novo Carrossel de Destaques (2/3) -->
                <div id="destaque-loading" class="md:col-span-2 bg-white shadow-lg rounded-lg p-6 animate-pulse h-96 flex items-center justify-center">Carregando destaques...</div>
                <div id="destaque-carousel-container" class="md:col-span-2 bg-gray-900 shadow-lg rounded-lg overflow-hidden hidden h-96 carousel-container">
                    
                    <div id="carousel-track" class="carousel-track h-full">
                        <!-- Slides ser√£o preenchidos pelo JavaScript -->
                    </div>

                    <!-- Navega√ß√£o (Bolinhas) -->
                    <div id="carousel-dots" class="carousel-dots">
                        <!-- Bolinhas ser√£o preenchidas pelo JavaScript -->
                    </div>

                </div>

                <!-- Mural Diocesano (1/3) - MODIFICADO CONFORME O SEU FICHEIRO -->
                <div id="mural-loading" class="bg-white shadow-lg rounded-lg p-6 h-96 flex flex-col items-center justify-center text-yellow-700">
                    <div class="mural-spinner mb-4"></div>
                    <p class="text-sm font-medium text-gray-500">Carregando mural...</p>
                </div>

                <div id="mural-content" class="bg-white shadow-lg rounded-lg overflow-hidden hidden h-96">
                    <div class="p-6 h-full flex flex-col">
                        <h2 class="text-2xl font-bold text-yellow-700 mb-1">Mural Diocesano</h2>
                        <p class="text-sm text-gray-600 mb-2 flex items-center gap-1">‚úùÔ∏è <span><strong>Paz e bem!</strong> Confira abaixo a liturgia e o santo do dia.</span></p>
                        <p id="mural-date" class="text-sm text-gray-500 mb-4 flex items-center gap-1"><span>üìÖ</span><span id="mural-date-text"></span></p>
                        
                        <!-- Abas do Mural -->
                        <div class="border-b border-gray-200">
                            <nav class="-mb-px flex space-x-4" aria-label="Tabs">
                                <button class="tab-button active" data-tab="liturgia">Liturgia</button>
                                <button class="tab-button" data-tab="santo">Santo do Dia</button>
                                <button class="tab-button" data-tab="eventos">Eventos</button>
                            </nav>
                        </div>
                        <!-- Conte√∫do das Abas -->
                        <div id="mural-tabs-content" class="mt-4 flex-1 overflow-y-auto">
                            <!-- Liturgia -->
                            <div id="tab-liturgia" class="tab-content active space-y-2">
                                <div class='flex flex-col items-center justify-center text-yellow-700'>
                                    <div class='mural-spinner mb-2'></div>
                                    <p class='text-sm text-gray-500'>Carregando liturgia...</p>
                                </div>
                            </div>
                            <!-- Santo do Dia -->
                            <div id="tab-santo" class="tab-content space-y-2">
                                <div class='flex flex-col items-center justify-center text-yellow-700'>
                                    <div class='mural-spinner mb-2'></div>
                                    <p class='text-sm text-gray-500'>Carregando santo...</p>
                                </div>
                            </div>
                            <!-- Eventos/Festas -->
                            <div id="tab-eventos" class="tab-content space-y-4">
                                <div>
                                    <h4 class="font-semibold text-gray-700">Festividades da Semana</h4>
                                    <ul id="festividades-list" class="list-disc list-inside text-sm text-gray-600">
                                        <p class_all_="" text-sm="" text-gray-500"="">Carregando...</p>
                                    </ul>
                                </div>
                                <div>
                                    <h4 class="font-semibold text-gray-700">An√∫ncios</h4>
                                    <ul id="anuncios-list" class="list-disc list-inside text-sm text-gray-600">
                                         <p class="text-sm text-gray-500">Carregando...</p>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2.2. BUSCA E LISTA DE PAR√ìQUIAS -->
            <div class="bg-white shadow-lg rounded-lg p-6">
                <h2 class="text-2xl font-bold text-yellow-700 mb-4">Encontre sua Par√≥quia</h2>
                <input id="search-input" type="text" placeholder="Buscar par√≥quia por nome, bairro ou cidade..." class="w-full p-3 border border-gray-300 rounded-lg">
                
                <div id="parishes-loading" class="mt-4 text-center text-gray-500">
                    <div class="loading-spinner inline-block" style="border-left-color: #b45309;"></div>
                    <span class="ml-2">Carregando par√≥quias...</span>
                </div>
                
                <div id="parishes-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mt-6">
                    <!-- Par√≥quias ser√£o preenchidas pelo JavaScript -->
                </div>
            </div>

        </main>

        <!-- 3. MODAL DE LOGIN (Oculto por padr√£o) -->
        <div id="login-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center p-4 hidden">
            <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md">
                <h2 class="text-2xl font-bold text-center text-yellow-700 mb-6">Acesso Restrito</h2>
                <div id="login-error" class="text-red-500 text-sm mb-4 hidden"></div>
                <form id="login-form">
                    <div class="mb-4">
                        <label for="login-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                        <input type="email" id="login-email" class="w-full p-2 border border-gray-300 rounded-lg" required>
                    </div>
                    <div class="mb-6">
                        <label for="login-password" class="block text-sm font-medium text-gray-700 mb-1">Senha</label>
                        <input type="password" id="login-password" class="w-full p-2 border border-gray-300 rounded-lg" required>
                    </div>
                    <button type="submit" id="login-submit-button" class="w-full bg-yellow-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-yellow-700 transition duration-200 flex items-center justify-center">
                        <span class="button-text">Entrar</span>
                        <div class="loading-spinner hidden"></div>
                    </button>
                    <button type="button" id="login-cancel-button" class="w-full bg-gray-200 text-gray-700 py-2 px-4 rounded-lg font-semibold hover:bg-gray-300 transition duration-200 mt-3">
                        Cancelar
                    </button>
                </form>
            </div>
        </div>

        <!-- 4. PAINEL DE ADMINISTRA√á√ÉO (Oculto por padr√£o, substitui o site p√∫blico) -->
        <div id="admin-panel" class="space-y-6 hidden">
            <!-- Conte√∫do do Painel de Admin (Super Admin OU Par√≥quia) ser√° preenchido pelo JavaScript -->
        </div>

    </div>

    <!-- 5. MODAL DE DETALHES DA PAR√ìQUIA (Oculto por padr√£o) -->
    <div id="parish-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center p-4 hidden overflow-y-auto">
        <div id="parish-modal-content" class="bg-white rounded-lg shadow-xl w-full max-w-3xl max-h-[90vh] overflow-y-auto">
            <!-- Conte√∫do do Modal da Par√≥quia ser√° preenchido pelo JavaScript -->
        </div>
    </div>


    <!-- ====================================================================== -->
    <!-- SCRIPT (L√ìGICA DO SITE) -->
    <!-- ====================================================================== -->

    <!-- --- 1. BIBLIOTECAS EXTERNAS --- -->
    
    <!-- Firebase Core (Obrigat√≥rio) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
    
    <!-- Firebase Firestore (Banco de Dados) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"></script>
    
    <!-- Firebase Authentication (Login) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js"></script>
    

    <script type="module">
        // --- 2. IMPORTA√á√ïES DOS M√ìCULOS FIREBASE ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { 
            getFirestore, collection, doc, getDoc, getDocs, onSnapshot,
            query, where, updateDoc, orderBy, limit, addDoc, Timestamp, deleteDoc
        } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
        import { 
            getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut 
        } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";

        // --- 3. CONFIGURA√á√ÉO DO FIREBASE ---
        const firebaseConfig = {
            apiKey: "AIzaSyCN8Wm-XqTkD4tcjlF-tTusRO92JA0c0Y0",
            authDomain: "unusdominus.firebaseapp.com",
            projectId: "unusdominus",
            storageBucket: "unusdominus.firebasestorage.app",
            messagingSenderId: "1040204777601",
            appId: "1:1040204777601:web:577008a19a846bc0462580",
        };
        // --- FIM DA CONFIGURA√á√ÉO OBRIGAT√ìRIA ---


        // --- 4. INICIALIZA√á√ÉO DO APP E SERVI√áOS ---
        let app, db, auth;
        let parishesCache = []; // Cache local para busca r√°pida
        let currentAdminParish = null; // Guarda o objeto {id, nome} da par√≥quia logada
        let isSuperAdmin = false; // Flag para Super Admin
        let parishAvisosUnsubscribe = null; // Para 'desligar' o listener de avisos
        let currentEditingAvisoId = null; // ID do aviso sendo editado

        // Vari√°veis do Carrossel
        let carouselTrack, carouselDots;
        let slides = [];
        let currentSlide = 0;
        let carouselInterval = null; // Para o auto-play

        // CORRE√á√ÉO PARA O SCRIPT ERROR:
        // Espera o HTML estar pronto antes de executar o Javascript
        document.addEventListener("DOMContentLoaded", () => {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                console.log("Firebase inicializado com sucesso!");
                
                // S√≥ inicializa a aplica√ß√£o e os listeners DEPOIS que o DOM e o Firebase carregarem.
                initializeAppListeners();

            } catch (error) {
                console.error("Erro ao inicializar o Firebase:", error);
                document.body.innerHTML = `<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded m-4" role="alert">
                    <strong class="font-bold">Erro de Configura√ß√£o!</strong>
                    <span class="block sm:inline">N√£o foi poss√≠vel conectar ao Firebase. Verifique se o objeto 'firebaseConfig' est√° correto no seu c√≥digo index.html.</span>
                </div>`;
            }
        });


        // --- 5. L√ìGICA DO SITE P√öBLICO ---

        // MODIFICA√á√ÉO: Fun√ß√£o auxiliar para formatar a data (do seu ficheiro)
        function formatarDataAtual() {
            const hoje = new Date();
            const opcoes = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            return hoje.toLocaleDateString('pt-BR', opcoes);
        }

        // Fun√ß√£o para carregar o conte√∫do global (Carrossel e Mural)
        async function loadGlobalContent() {
            // Carrega o Mural (globalContent/main E APIs)
            loadMural();
            // Carrega o Carrossel (cole√ß√£o 'destaques')
            loadCarousel();
        }

        // Fun√ß√£o para carregar o Carrossel
        async function loadCarousel() {
            try {
                // A cole√ß√£o 'destaques' agora cont√©m os eventos APROVADOS
                const destaquesCol = collection(db, "destaques"); 
                const q = query(destaquesCol, orderBy("dataEvento", "desc"), limit(10));

                onSnapshot(q, (snapshot) => {
                    try { // Adiciona try para capturar erros de renderiza√ß√£o
                        if (carouselInterval) clearInterval(carouselInterval); // Para o auto-play

                        const track = document.getElementById("carousel-track");
                        const dotsContainer = document.getElementById("carousel-dots");
                        
                        track.innerHTML = '';
                        dotsContainer.innerHTML = '';
                        slides = [];
                        currentSlide = 0;

                        if (snapshot.empty) {
                            document.getElementById("destaque-loading").innerText = "Nenhum evento em destaque no momento.";
                            return;
                        }

                        snapshot.forEach((doc, index) => {
                            const data = doc.data();
                            slides.push(data);

                            // Cria o Slide
                            const slide = document.createElement('a');
                            slide.href = data.link || '#';
                            slide.target = data.link ? '_blank' : '_self';
                            slide.className = 'carousel-slide';
                            slide.innerHTML = `
                                <img src="${data.imagemUrl || 'https://placehold.co/800x400/c2b280/FFFFFF?text=Evento'}" alt="${data.titulo}" class="w-full h-full object-cover">
                                <div class="absolute inset-0 bg-gradient-to-t from-black/70 via-black/30 to-transparent"></div>
                                <div class="absolute bottom-0 left-0 p-6 md:p-8 text-white">
                                    <h3 class="text-2xl md:text-3xl font-bold">${data.titulo}</h3>
                                    <p class="text-lg md:text-xl">${data.subtitulo}</p>
                                </div>
                            `;
                            track.appendChild(slide);

                            // Cria a Bolinha (Dot)
                            const dot = document.createElement('button');
                            dot.className = 'carousel-dot';
                            dot.dataset.slide = index;
                            if (index === 0) dot.classList.add('active');
                            dotsContainer.appendChild(dot);
                        });
                        
                        if (slides.length <= 1) {
                            dotsContainer.style.display = 'none'; // Esconde bolinhas se for s√≥ 1 slide
                        }

                        // Seleciona os elementos criados
                        carouselTrack = document.getElementById("carousel-track");
                        carouselDots = document.getElementById("carousel-dots");
                        
                        // Inicia o carrossel
                        updateSlidePosition();
                        document.getElementById("destaque-loading").style.display = 'none';
                        document.getElementById("destaque-carousel-container").classList.remove("hidden");

                        // Inicia auto-play se tiver mais de 1 slide
                        if (slides.length > 1) {
                            carouselInterval = setInterval(nextSlide, 8000); // 8 segundos
                        }
                    } catch (e) {
                        console.error("Erro renderizando carrossel:", e);
                        document.getElementById("destaque-loading").innerText = "Erro ao renderizar destaques.";
                    }
                }, (error) => {
                     console.error("Erro ao carregar destaques do Firestore: ", error);
                     document.getElementById("destaque-loading").innerText = "Erro ao carregar destaques.";
                });

            } catch (error) {
                console.error("Erro ao carregar carrossel:", error);
            }
        }

        // Fun√ß√µes de controle do Carrossel
        function goToSlide(slideIndex) {
            currentSlide = slideIndex;
            updateSlidePosition();
            updateDots();
        }

        function nextSlide() {
            if (slides.length === 0) return;
            const newIndex = (currentSlide + 1) % slides.length;
            goToSlide(newIndex);
        }

        function updateSlidePosition() {
            if (carouselTrack) {
                carouselTrack.style.transform = `translateX(-${currentSlide * 100}%)`;
            }
        }

        function updateDots() {
            if (carouselDots) {
                Array.from(carouselDots.children).forEach((dot, index) => {
                    dot.classList.toggle('active', index === currentSlide);
                });
            }
        }

        // --- MODIFICA√á√ÉO: Fun√ß√µes do Mural (do seu ficheiro) ---
        async function carregarLiturgia() {
            try {
                const res = await fetch('https://liturgia.up.railway.app/');
                if (!res.ok) throw new Error('Erro na API principal');
                const data = await res.json();
                return `
                    <h4 class='font-semibold text-gray-700'>${data.dia}</h4>
                    <div class='text-sm text-gray-600 mt-2 space-y-2'>
                    <p><strong>1¬™ Leitura:</strong> ${data.liturgia.primeiraLeitura.titulo}</p>
                    <p><strong>Salmo:</strong> ${data.liturgia.salmo.titulo}</p>
                    <p><strong>Evangelho:</strong> ${data.liturgia.evangelho.titulo}</p>
                    </div>
                    <hr class='my-2'>
                    <details class='text-sm text-gray-600'>
                    <summary class='cursor-pointer text-yellow-700 font-medium'>Ver textos completos</summary>
                    <div class='mt-2 space-y-2'>
                        <p><strong>1¬™ Leitura:</strong><br>${data.liturgia.primeiraLeitura.texto}</p>
                        <p><strong>Salmo:</strong><br>${data.liturgia.salmo.texto}</p>
                        <p><strong>Evangelho:</strong><br>${data.liturgia.evangelho.texto}</p>
                    </div>
                    </details>
                `;
            } catch (error) {
                console.warn('Erro ao buscar liturgia, usando fallback:', error);
                return `<p class='text-sm text-gray-600'>N√£o foi poss√≠vel carregar a liturgia de hoje. Tente novamente mais tarde.</p>`;
            }
        }

        async function carregarSanto(santoTab) {
            try {
                const santoRes = await fetch('https://www.santoapi.com/api/v1/today');
                if (!santoRes.ok) throw new Error('Erro na API de santo');
                const santoData = await santoRes.json();
                santoTab.innerHTML = `
                    <img src='${santoData.image || 'https://placehold.co/300x200/c2b280/FFFFFF?text=Santo+do+Dia'}' class='w-full h-32 object-cover rounded-lg mb-2'>
                    <h4 class='font-semibold text-gray-700'>${santoData.name}</h4>
                    <p class='text-sm text-gray-600'>${santoData.description ? santoData.description.substring(0, 150) + '...' : 'Sem descri√ß√£o dispon√≠vel.'}</p>
                `;
            } catch (errSanto) {
                console.warn('Erro ao buscar Santo do Dia:', errSanto);
                santoTab.innerHTML = `
                    <img src='https://placehold.co/300x200/c2b280/FFFFFF?text=Santo+do+Dia' class='w-full h-32 object-cover rounded-lg mb-2'>
                    <h4 class='font-semibold text-gray-700'>Santo do Dia</h4>
                    <p class='text-sm text-gray-600'>N√£o foi poss√≠vel carregar o Santo do Dia. Verifique sua conex√£o.</p>
                `;
            }
        }

        // --- MODIFICA√á√ÉO: 'loadMural' AGORA √â H√çBRIDO (APIs + FIRESTORE) ---
        async function loadMural() {
            const liturgiaTab = document.getElementById('tab-liturgia');
            const santoTab = document.getElementById('tab-santo');
            const festasList = document.getElementById('festividades-list');
            const anunciosList = document.getElementById('anuncios-list');

            // Define a data atual
            document.getElementById('mural-date-text').textContent = formatarDataAtual();
            
            // Define a aba ativa inicial
            if (!document.querySelector('.tab-button.active')) {
                document.querySelector('.tab-button[data-tab="liturgia"]').classList.add('active');
                document.getElementById('tab-liturgia').classList.add('active');
            }

            // Exibe o spinner principal
            document.getElementById('mural-loading').style.display = 'flex';

            // Carrega APIs
            const liturgiaHTML = await carregarLiturgia();
            liturgiaTab.innerHTML = liturgiaHTML;
            await carregarSanto(santoTab);

            // === 3Ô∏è‚É£ FESTIVIDADES E AN√öNCIOS (DO *NOSSO* FIRESTORE) ===
            // Esta parte foi preservada e mesclada
            try {
                const docRef = doc(db, "globalContent", "main");
                onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        
                        // Eventos (do Firestore)
                        festasList.innerHTML = '';
                        if (data?.festividadesSemana?.length > 0) {
                            data.festividadesSemana.forEach(f => {
                                festasList.innerHTML += `<li><strong>${f.dia}:</strong> ${f.evento}</li>`;
                            });
                        } else {
                            festasList.innerHTML = '<li>Nenhuma festividade cadastrada.</li>';
                        }

                        // An√∫ncios (do Firestore)
                        anunciosList.innerHTML = '';
                        if (data?.anuncios?.length > 0) {
                            data.anuncios.forEach(a => {
                                anunciosList.innerHTML += `<li><strong>${a.titulo}:</strong> ${a.descricao}</li>`;
                            });
                        } else {
                            anunciosList.innerHTML = '<li>Nenhum an√∫ncio cadastrado.</li>';
                        }
                    } else {
                         festasList.innerHTML = '<li>Erro: Documento global n√£o encontrado.</li>';
                         anunciosList.innerHTML = '<li>Erro: Documento global n√£o encontrado.</li>';
                    }
                }, (error) => {
                    console.error("Erro ao carregar eventos/an√∫ncios do Firestore:", error);
                    festasList.innerHTML = '<li>Erro ao carregar eventos.</li>';
                    anunciosList.innerHTML = '<li>Erro ao carregar an√∫ncios.</li>';
                });
            } catch(err) {
                console.error("Erro ao carregar dados do Firestore no Mural:", err);
                festasList.innerHTML = '<li>Erro ao carregar eventos.</li>';
                anunciosList.innerHTML = '<li>Erro ao carregar an√∫ncios.</li>';
            }
            
            // Esconde o spinner principal e mostra o conte√∫do
            document.getElementById('mural-loading').style.display = 'none';
            document.getElementById('mural-content').classList.remove('hidden');
        }
        
        // Fun√ß√£o para carregar todas as par√≥quias
        async function loadParishes() {
            try {
                const parishesCollection = collection(db, "parishes");
                const q = query(parishesCollection);
                
                onSnapshot(q, (querySnapshot) => {
                    try { // Adiciona try para capturar erros de renderiza√ß√£o
                        parishesCache = []; // Limpa o cache
                        const listElement = document.getElementById("parishes-list");
                        listElement.innerHTML = ''; // Limpa a lista atual
                        
                        if (querySnapshot.empty) {
                            listElement.innerHTML = '<p class="text-gray-500 col-span-full">Nenhuma par√≥quia cadastrada ainda.</p>';
                        }

                        querySnapshot.forEach((doc) => {
                            const parish = { id: doc.id, ...doc.data() };
                            parishesCache.push(parish); // Adiciona ao cache
                            
                            const card = `
                                <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden cursor-pointer hover:shadow-md transition-shadow" data-parish-id="${parish.id}">
                                    <img src="${parish.fotoUrl || 'https://placehold.co/400x250/c2b280/FFFFFF?text=Igreja'}" alt="${parish.nome}" class="w-full h-48 object-cover">
                                    <div class="p-4">
                                        <h3 class="text-lg font-semibold text-yellow-700">${parish.nome}</h3>
                                        <p class="text-sm text-gray-500 truncate">${parish.endereco || 'Endere√ßo n√£o informado'}</p>
                                    </div>
                                </div>
                            `;
                            listElement.innerHTML += card;
                        });
                        
                        document.getElementById("parishes-loading").style.display = 'none';
                    } catch (e) {
                        console.error("Erro renderizando par√≥quias:", e);
                        document.getElementById("parishes-loading").innerText = "Erro ao renderizar par√≥quias.";
                    }
                }, (error) => {
                    console.error("Erro ao carregar par√≥quias do Firestore: ", error);
                    document.getElementById("parishes-loading").innerText = "Erro ao carregar par√≥quias.";
                });
            } catch (error)
 {
                console.error("Erro ao carregar par√≥quias:", error);
            }
        }

        // Fun√ß√£o para filtrar par√≥quias (usa o cache local)
        function filterParishes() {
            const searchTerm = document.getElementById("search-input").value.toLowerCase();
            const listElement = document.getElementById("parishes-list");
            listElement.innerHTML = '';
            
            const filtered = parishesCache.filter(p => 
                p.nome.toLowerCase().includes(searchTerm) ||
                (p.endereco && p.endereco.toLowerCase().includes(searchTerm))
            );

            if (filtered.length === 0) {
                listElement.innerHTML = '<p class="text-gray-500 col-span-full">Nenhuma par√≥quia encontrada com este termo.</p>';
                return;
            }

            filtered.forEach(parish => {
                const card = `
                    <div class="bg-white rounded-lg shadow-sm border border-gray-200 overflow-hidden cursor-pointer hover:shadow-md transition-shadow" data-parish-id="${parish.id}">
                        <img src="${parish.fotoUrl || 'https://placehold.co/400x250/c2b280/FFFFFF?text=Igreja'}" alt="${parish.nome}" class="w-full h-48 object-cover">
                        <div class="p-4">
                            <h3 class="text-lg font-semibold text-yellow-700">${parish.nome}</h3>
                            <p class="text-sm text-gray-500 truncate">${parish.endereco || 'Endere√ßo n√£o informado'}</p>
                        </div>
                    </div>
                `;
                listElement.innerHTML += card;
            });
        }
        
        // Fun√ß√£o para mostrar o modal de detalhes da par√≥quia
        async function showParishDetails(parishId) {
            try {
                const parish = parishesCache.find(p => p.id === parishId);
                if (!parish) return;

                const modal = document.getElementById("parish-modal");
                const content = document.getElementById("parish-modal-content");
                
                let missasHtml = '<li>Nenhum hor√°rio cadastrado.</li>';
                if (parish.missas?.length > 0) {
                    missasHtml = parish.missas.map(m => `<li><span class="font-semibold">${m.dia}:</span> ${m.horarios}</li>`).join('');
                }

                // NOVO: Carrega avisos da subcole√ß√£o
                let avisosHtml = '<li>Carregando avisos...</li>';
                content.innerHTML = `<div class="p-10 text-center"><div class="loading-spinner inline-block" style="border-left-color: #b45309;"></div></div>`;
                modal.classList.remove('hidden');

                try {
                    const avisosColRef = collection(db, "parishes", parishId, "avisos");
                    const q = query(avisosColRef, orderBy("dataPublicacao", "desc"), limit(10));
                    const avisosSnapshot = await getDocs(q);
                    
                    if (avisosSnapshot.empty) {
                        avisosHtml = '<li>Nenhum aviso cadastrado.</li>';
                    } else {
                        avisosHtml = avisosSnapshot.docs.map(doc => {
                            const aviso = doc.data();
                            const dataAv = aviso.dataPublicacao.toDate().toLocaleDateString('pt-BR');
                            return `
                                <div class="bg-gray-50 border-l-4 border-yellow-600 p-4 mb-2 rounded-r-lg">
                                    <h4 class="font-semibold">${aviso.titulo}</h4>
                                    <p class="text-sm text-gray-500 mb-1">${dataAv}</p>
                                    <p class="text-sm">${aviso.descricao}</p>
                                    ${aviso.imagemUrl ? `<img src="${aviso.imagemUrl}" alt="Imagem do aviso" class="mt-2 rounded-lg w-full h-48 object-cover">` : ''}
                                </div>
                            `;
                        }).join('');
                    }
                } catch (err) {
                    console.error("Erro ao buscar avisos da subcole√ß√£o:", err);
                    avisosHtml = '<li>Erro ao carregar avisos.</li>';
                }
                
                // Renderiza o conte√∫do completo do modal
                content.innerHTML = `
                    <img src="${parish.fotoUrl || 'https://placehold.co/600x300/c2b280/FFFFFF?text=Igreja'}" alt="${parish.nome}" class="w-full h-64 object-cover rounded-t-lg">
                    <div class="p-6 space-y-4">
                        <h2 class="text-2xl font-bold text-yellow-700">${parish.nome}</h2>
                        <p class="text-gray-600 italic">P√°roco: ${parish.paroco || 'N√£o informado'}</p>
                        
                        <div class="border-t pt-4">
                            <h3 class="text-lg font-semibold mb-2">Informa√ß√µes</h3>
                            <p>${parish.endereco || 'Endere√ßo n√£o informado'}</p>
                            <p>${parish.telefone || 'Telefone n√£o informado'}</p>
                            <p>${parish.email || 'Email n√£o informado'}</p>
                        </div>
                        
                        <div class="border-t pt-4">
                            <h3 class="text-lg font-semibold mb-2">Hor√°rios das Missas</h3>
                            <ul class="list-disc list-inside space-y-1">${missasHtml}</ul>
                        </div>
                        
                        <div class="border-t pt-4">
                            <h3 class="text-lg font-semibold mb-2">Confiss√µes</h3>
                            <p>${parish.confissoes || 'N√£o informado'}</p>
                        </div>

                        <div class="border-t pt-4">
                            <h3 class="text-lg font-semibold mb-2">Mural de Avisos</h3>
                            ${avisosHtml}
                        </div>

                        <button id="parish-modal-close" class="w-full bg-gray-200 text-gray-700 py-2 px-4 rounded-lg font-semibold hover:bg-gray-300 transition duration-200 mt-4">
                            Fechar
                        </button>
                    </div>
                `;
            } catch (error) {
                console.error("Erro fatal ao mostrar detalhes:", error);
                // Fecha o modal se algo der errado
                document.getElementById("parish-modal").classList.add("hidden");
                document.getElementById("parish-modal-content").innerHTML = "";
            }
        }


        // --- 6. L√ìGICA DE AUTENTICA√á√ÉO E PAINEL ADMIN ---
        
        // Verifica o tipo de usu√°rio (Par√≥quia ou Super Admin)
        async function checkUserRole(user) {
            try {
                // 1. Verifica se √© Super Admin
                const adminDocRef = doc(db, "admins", user.uid);
                const adminDocSnap = await getDoc(adminDocRef);
                
                if (adminDocSnap.exists()) {
                    isSuperAdmin = true;
                    currentAdminParish = null; // Super admin n√£o tem par√≥quia
                    showSuperAdminPanel(user);
                    return;
                }

                // 2. Se n√£o for Super Admin, verifica se √© Admin de Par√≥quia
                const q = query(collection(db, "parishes"), where("ownerUid", "==", user.uid));
                const querySnapshot = await getDocs(q);

                if (!querySnapshot.empty) {
                    const parishDoc = querySnapshot.docs[0];
                    isSuperAdmin = false;
                    currentAdminParish = { id: parishDoc.id, nome: parishDoc.data().nome };
                    showParishAdminPanel(parishDoc.id, parishDoc.data(), user.email);
                    return;
                }

                // 3. Se n√£o for nenhum, √© um erro
                alert("Erro: Seu usu√°rio est√° logado, mas n√£o est√° associado a nenhuma par√≥quia nem √© um Super Administrador.");
                await signOut(auth);
            } catch (error) {
                console.error("Erro fatal ao verificar permiss√£o:", error);
                alert("Ocorreu um erro ao verificar suas permiss√µes.");
                await signOut(auth);
            }
        }

        // Fun√ß√£o auxiliar para formatar Timestamp para input datetime-local
        function toLocalISOString(timestamp) {
            if (!timestamp || !timestamp.toDate) return '';
            const date = timestamp.toDate();
            // Subtrai o fuso hor√°rio para converter UTC para local
            const tzoffset = (new Date()).getTimezoneOffset() * 60000; //offset in milliseconds
            const localISOTime = (new Date(date.getTime() - tzoffset)).toISOString().slice(0, 16);
            return localISOTime;
        }
        
        // Renderiza o HTML do Painel de Admin (Par√≥quia)
        function showParishAdminPanel(parishId, parish, userEmail) {
            const panel = document.getElementById("admin-panel");
            panel.innerHTML = ""; // Limpa o painel
            
            // Converte arrays em campos de texto simples
            const missasText = (parish.missas || []).map(m => `${m.dia}: ${m.horarios}`).join('\n');
            
            // Painel 1: Editar Informa√ß√µes da Par√≥quia
            const parishEditor = document.createElement('div');
            parishEditor.className = "bg-white shadow-lg rounded-lg p-6 md:p-8";
            parishEditor.innerHTML = `
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-yellow-700">Painel da ${parish.nome}</h2>
                        <p class="text-gray-500">Logado como: ${userEmail}</p>
                    </div>
                </div>

                <form id="admin-form" class="space-y-6">
                    <!-- ... (Campos: P√°roco, Telefone, Email, Endere√ßo) ... -->
                    <div class="border-b pb-6">
                        <h3 class="text-lg font-semibold mb-2">Informa√ß√µes B√°sicas</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium">P√°roco</label>
                                <input type="text" id="admin-paroco" value="${parish.paroco || ''}" class="w-full p-2 border border-gray-300 rounded-lg mt-1">
                            </div>
                            <div>
                                <label class="block text-sm font-medium">Telefone</label>
                                <input type="text" id="admin-telefone" value="${parish.telefone || ''}" class="w-full p-2 border border-gray-300 rounded-lg mt-1">
                            </div>
                            <div>
                                <label class="block text-sm font-medium">Email</label>
                                <input type="email" id="admin-email" value="${parish.email || ''}" class="w-full p-2 border border-gray-300 rounded-lg mt-1">
                            </div>
                            <div>
                                <label class="block text-sm font-medium">Endere√ßo</label>
                                <input type="text" id="admin-endereco" value="${parish.endereco || ''}" class="w-full p-2 border border-gray-300 rounded-lg mt-1" readonly disabled title="Endere√ßo n√£o pode ser alterado por aqui">
                            </div>
                        </div>
                    </div>

                    <!-- ... (Campos: Missas, Confiss√µes) ... -->
                    <div class="border-b pb-6">
                        <h3 class="text-lg font-semibold mb-2">Hor√°rios de Missa</h3>
                        <textarea id="admin-missas" rows="5" class="w-full p-2 border border-gray-300 rounded-lg mt-1 font-mono" placeholder="Formato: Dia: Hor√°rios (um por linha)&#10;Ex: Domingo: 07:00, 09:00&#10;Ex: Segunda a Sexta: 19:00">${missasText}</textarea>
                        
                        <label class="block text-sm font-medium mt-4">Hor√°rios de Confiss√£o</label>
                        <input type="text" id="admin-confissoes" value="${parish.confissoes || ''}" class="w-full p-2 border border-gray-300 rounded-lg mt-1">
                    </div>

                    <!-- ... (Campo: Foto da Par√≥quia) ... -->
                    <div class="border-b pb-6">
                        <h3 class="text-lg font-semibold mb-2">Foto da Par√≥quia</h3>
                        <p class="text-sm text-gray-500 mb-2">Para alterar, escolha uma nova foto abaixo. A imagem antiga ser√° substitu√≠da.</p>
                        <div class="flex items-center space-x-4">
                            <img src="${parish.fotoUrl || 'https://placehold.co/100x100/c2b280/FFFFFF?text=Sem+Foto'}" alt="Foto atual" class="w-24 h-24 object-cover rounded-lg border" id="admin-foto-preview">
                            <input type="file" id="admin-foto" accept="image/png, image/jpeg, image/webp">
                        </div>
                    </div>

                    <!-- ... (Bot√£o Salvar) ... -->
                    <div id="admin-save-feedback" class="h-10"></div>
                    <button type="submit" id="admin-save-button" class="w-full bg-green-600 text-white py-3 px-4 rounded-lg font-semibold hover:bg-green-700 transition duration-200 flex items-center justify-center">
                        <span class="button-text">Salvar Altera√ß√µes (Infos e Foto)</span>
                        <div class="loading-spinner hidden"></div>
                    </button>
                </form>
            `;
            panel.appendChild(parishEditor);
            
            // Painel 2: Gerenciador de Avisos e Eventos
            const eventManager = document.createElement('div');
            eventManager.className = "bg-white shadow-lg rounded-lg p-6 md:p-8 mt-6";
            eventManager.innerHTML = `
                <h2 class="text-2xl font-bold text-yellow-700 mb-6">Mural de Avisos e Eventos</h2>
                
                <!-- Formul√°rio para Novo Aviso / Edi√ß√£o -->
                <form id="aviso-form" class="space-y-4 p-4 border rounded-lg bg-gray-50">
                    <h3 id="aviso-form-title" class="text-lg font-semibold">Adicionar Novo Aviso / Evento</h3>
                    <div>
                        <label class="block text-sm font-medium">T√≠tulo*</label>
                        <input type="text" id="aviso-titulo" class="w-full p-2 border border-gray-300 rounded-lg mt-1" required>
                    </div>
                    <div>
                        <label class="block text-sm font-medium">Descri√ß√£o*</label>
                        <textarea id="aviso-descricao" rows="3" class="w-full p-2 border border-gray-300 rounded-lg mt-1" required></textarea>
                    </div>
                    
                    <!-- CAMPO DE DATA (CORRIGIDO) -->
                    <div>
                        <label class="block text-sm font-medium">Data e Hora do Evento (se aplic√°vel)</label>
                        <input type="datetime-local" id="aviso-data" class="w-full p-2 border border-gray-300 rounded-lg mt-1">
                        <p class="text-xs text-gray-500 mt-1">Se for um evento com data, preencha. Obrigat√≥rio se for solicitar destaque.</p>
                    </div>

                    <div>
                        <label class="block text-sm font-medium">Imagem (Opcional - para destaque)</label>
                        <input type="file" id="aviso-foto" class="w-full" accept="image/png, image/jpeg, image/webp">
                        <p class="text-xs text-gray-500 mt-1">Selecione uma nova imagem para alterar a existente (se houver).</p>
                    </div>
                    <div class="flex items-center">
                        <input type="checkbox" id="aviso-solicitar-destaque" class="h-4 w-4 rounded border-gray-300 text-yellow-600 focus:ring-yellow-500">
                        <label for="aviso-solicitar-destaque" class="ml-2 block text-sm text-gray-900">Solicitar destaque no carrossel da p√°gina inicial</label>
                    </div>
                    
                    <div id="aviso-feedback" class="h-10"></div>
                    <div class="flex flex-col sm:flex-row gap-2">
                        <button type="submit" id="aviso-submit-button" class="w-full bg-blue-600 text-white py-2 px-4 rounded-lg font-semibold hover:bg-blue-700 transition duration-200 flex items-center justify-center">
                            <span class="button-text">Publicar Aviso</span>
                            <div class="loading-spinner hidden"></div>
                        </button>
                        <button type="button" id="aviso-cancel-edit-button" class="w-full sm:w-auto bg-gray-200 text-gray-700 py-2 px-4 rounded-lg font-semibold hover:bg-gray-300 transition duration-200 hidden">
                            Cancelar Edi√ß√£o
                        </button>
                    </div>
                </form>

                <!-- Lista de Avisos Atuais -->
                <div class="mt-6">
                    <h3 class="text-lg font-semibold">Avisos Publicados</h3>
                    <div id="aviso-loading" class="text-gray-500 mt-2">Carregando avisos...</div>
                    <div id="aviso-list" class="space-y-3 mt-4">
                        <!-- Avisos da par√≥quia ser√£o carregados aqui -->
                    </div>
                </div>
            `;
            panel.appendChild(eventManager);

            // Adiciona listeners para os formul√°rios
            document.getElementById("admin-form").addEventListener("submit", handleParishSaveChanges);
            document.getElementById("aviso-form").addEventListener("submit", handleAvisoSubmit);
            document.getElementById("aviso-cancel-edit-button").addEventListener("click", resetAvisoForm);
            
            // Carrega os avisos da par√≥quia
            loadParishAvisos(parishId);
        }
        
        // Carrega a lista de avisos da par√≥quia no painel de admin
        function loadParishAvisos(parishId) {
            const listDiv = document.getElementById("aviso-list");
            const loadingDiv = document.getElementById("aviso-loading");
            const avisosColRef = collection(db, "parishes", parishId, "avisos");
            const q = query(avisosColRef, orderBy("dataPublicacao", "desc"), limit(10));
            
            // Cancela o listener anterior (se houver) para evitar duplicatas
            if (parishAvisosUnsubscribe) parishAvisosUnsubscribe();

            parishAvisosUnsubscribe = onSnapshot(q, (snapshot) => {
                try { // Adiciona try para capturar erros de renderiza√ß√£o
                    listDiv.innerHTML = ""; // Limpa a lista
                    if (snapshot.empty) {
                        loadingDiv.innerText = "Nenhum aviso publicado.";
                        return;
                    }
                    loadingDiv.style.display = 'none';

                    snapshot.forEach(doc => {
                        const aviso = { id: doc.id, ...doc.data() };
                        const dataAv = aviso.dataPublicacao.toDate().toLocaleDateString('pt-BR');
                        
                        // Converte o Timestamp do evento para o formato do input
                        const dataEventoStr = toLocalISOString(aviso.dataEvento);
                        
                        // Escapa aspas simples e duplas para o dataset
                        const tituloEscapado = aviso.titulo.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                        const descricaoEscapada = aviso.descricao.replace(/"/g, '&quot;').replace(/'/g, '&#39;');

                        const card = document.createElement('div');
                        card.className = "flex items-center gap-4 p-3 border rounded-lg";
                        card.innerHTML = `
                            ${aviso.imagemUrl ? `<img src="${aviso.imagemUrl}" class="w-16 h-16 object-cover rounded">` : '<div class="w-16 h-16 bg-gray-100 rounded flex items-center justify-center text-gray-400">Sem Foto</div>'}
                            <div class="flex-1">
                                <h4 class="font-semibold">${aviso.titulo}</h4>
                                <p class="text-sm text-gray-600">${aviso.descricao.substring(0, 50)}...</p>
                                <p class="text-xs text-gray-400">Publicado em: ${dataAv}</p>
                                ${aviso.statusDestaque ? `<span class="text-xs font-medium ${aviso.statusDestaque === 'pendente' ? 'text-yellow-600' : 'text-green-600'}">Destaque: ${aviso.statusDestaque}</span>` : ''}
                            </div>
                            <button class="edit-aviso-button bg-gray-100 text-gray-700 px-3 py-1 rounded text-sm" 
                                data-id="${aviso.id}" 
                                data-titulo="${tituloEscapado}" 
                                data-descricao="${descricaoEscapada}"
                                data-dataevento="${dataEventoStr}"
                                data-solicitar="${aviso.statusDestaque ? 'true' : 'false'}">
                                Editar
                            </button>
                            <button class="delete-aviso-button bg-red-100 text-red-700 px-3 py-1 rounded text-sm" data-id="${aviso.id}">Excluir</button>
                        `;
                        listDiv.appendChild(card);
                    });
                    
                    // Adiciona listener para os bot√µes de editar e deletar
                    document.querySelectorAll(".edit-aviso-button").forEach(btn => {
                        btn.addEventListener('click', handleEditAviso);
                    });
                    document.querySelectorAll(".delete-aviso-button").forEach(btn => {
                        btn.addEventListener('click', handleDeleteAviso);
                    });
                } catch (e) {
                    console.error("Erro renderizando avisos da par√≥quia:", e);
                    loadingDiv.innerText = "Erro ao renderizar avisos.";
                }
            }, (error) => {
                console.error("Erro ao carregar avisos da par√≥quia:", error);
                loadingDiv.innerText = "Erro ao carregar avisos.";
            });
        }
        
        // Fun√ß√£o para preencher o formul√°rio para Edi√ß√£o de Aviso
        function handleEditAviso(e) {
            const btn = e.target;
            currentEditingAvisoId = btn.dataset.id;
            
            // Preenche o formul√°rio
            document.getElementById("aviso-form-title").innerText = "Editando Aviso / Evento";
            document.getElementById("aviso-titulo").value = btn.dataset.titulo;
            document.getElementById("aviso-descricao").value = btn.dataset.descricao;
            document.getElementById("aviso-data").value = btn.dataset.dataevento; // CORRIGIDO
            document.getElementById("aviso-solicitar-destaque").checked = (btn.dataset.solicitar === 'true');
            
            // Altera o bot√£o
            const submitButton = document.getElementById("aviso-submit-button");
            submitButton.querySelector('.button-text').innerText = "Salvar Edi√ß√£o";
            submitButton.classList.remove('bg-blue-600', 'hover:bg-blue-700');
            submitButton.classList.add('bg-orange-500', 'hover:bg-orange-600');

            // Mostra o bot√£o "Cancelar Edi√ß√£o"
            document.getElementById("aviso-cancel-edit-button").classList.remove("hidden");
            
            // Foca no formul√°rio
            document.getElementById("aviso-form").scrollIntoView({ behavior: 'smooth' });
        }
        
        // Fun√ß√£o para resetar o formul√°rio de aviso
        function resetAvisoForm() {
            currentEditingAvisoId = null;
            document.getElementById("aviso-form").reset();
            
            document.getElementById("aviso-form-title").innerText = "Adicionar Novo Aviso / Evento";
            const submitButton = document.getElementById("aviso-submit-button");
            submitButton.querySelector('.button-text').innerText = "Publicar Aviso";
            submitButton.classList.add('bg-blue-600', 'hover:bg-blue-700');
            submitButton.classList.remove('bg-orange-500', 'hover:bg-orange-600');
            
            document.getElementById("aviso-feedback").innerHTML = "";
            document.getElementById("aviso-cancel-edit-button").classList.add("hidden");
        }
        
        // Fun√ß√£o para Deletar um Aviso
        async function handleDeleteAviso(e) {
            const avisoId = e.target.dataset.id;
            if (!confirm("Tem certeza que deseja excluir este aviso? Esta a√ß√£o n√£o pode ser desfeita.")) return;
            
            try {
                // TODO: Deletar tamb√©m a solicita√ß√£o de destaque se houver?
                const avisoDocRef = doc(db, "parishes", currentAdminParish.id, "avisos", avisoId);
                await deleteDoc(avisoDocRef);
                // O onSnapshot atualizar√° a lista
            } catch (error) {
                console.error("Erro ao excluir aviso:", error);
                alert("Erro ao excluir aviso: " + error.message);
            }
        }

        // Fun√ß√£o para Salvar as Mudan√ßas da Par√≥quia (Infos e Foto)
        async function handleParishSaveChanges(e) {
            e.preventDefault();
            
            const saveButton = document.getElementById("admin-save-button");
            const feedbackDiv = document.getElementById("admin-save-feedback");

            // Mostrar loading
            saveButton.querySelector('.button-text').classList.add('hidden');
            saveButton.querySelector('.loading-spinner').classList.remove('hidden');
            saveButton.disabled = true;
            feedbackDiv.innerHTML = '<p class="text-blue-600">Salvando, por favor aguarde...</p>';

            try {
                let newFotoUrl = null;
                const fileInput = document.getElementById("admin-foto");
                const file = fileInput.files[0];

                // ETAPA 1: Upload da Imagem da Par√≥quia (se houver)
                if (file) {
                    feedbackDiv.innerHTML = '<p class="text-blue-600">Enviando imagem...</p>';
                    newFotoUrl = await uploadImageToCloudinary(file);
                    console.log('Upload da imagem da par√≥quia conclu√≠do:', newFotoUrl);
                } else {
                    console.log("Nenhuma nova imagem de par√≥quia selecionada.");
                }

                // ETAPA 2: Preparar Dados do Formul√°rio
                feedbackDiv.innerHTML = '<p class="text-blue-600">Atualizando banco de dados...</p>';
                const missasText = document.getElementById("admin-missas").value.trim();
                const missasArray = missasText.split('\n')
                    .filter(line => line.includes(':'))
                    .map(line => ({
                        dia: line.split(':')[0].trim(),
                        horarios: line.split(':').slice(1).join(':').trim()
                    }));
                
                const dataToUpdate = {
                    paroco: document.getElementById("admin-paroco").value,
                    telefone: document.getElementById("admin-telefone").value,
                    email: document.getElementById("admin-email").value,
                    confissoes: document.getElementById("admin-confissoes").value,
                    missas: missasArray,
                };

                if (newFotoUrl) {
                    dataToUpdate.fotoUrl = newFotoUrl;
                }

                // ETAPA 3: Salvar no Firestore
                const docRef = doc(db, "parishes", currentAdminParish.id);
                await updateDoc(docRef, dataToUpdate);

                // Sucesso!
                feedbackDiv.innerHTML = '<p class="text-green-600 font-semibold">Altera√ß√µes salvas com sucesso!</p>';
                if (newFotoUrl) {
                    document.getElementById("admin-foto-preview").src = newFotoUrl;
                }
                
                setTimeout(() => { feedbackDiv.innerHTML = ''; }, 3000);

            } catch (error) {
                console.error("Erro ao salvar altera√ß√µes da par√≥quia:", error);
                feedbackDiv.innerHTML = `<p class="text-red-600 font-semibold">Erro ao salvar: ${error.message}</p>`;
            } finally {
                // Restaurar o bot√£o
                saveButton.querySelector('.button-text').classList.remove('hidden');
                saveButton.querySelector('.loading-spinner').classList.add('hidden');
                saveButton.disabled = false;
            }
        }
        
        // Fun√ß√£o para Enviar um Novo Aviso (e talvez solicitar destaque)
        async function handleAvisoSubmit(e) {
            e.preventDefault();
            
            const isEditing = currentEditingAvisoId !== null;
            const submitButton = document.getElementById("aviso-submit-button");
            const feedbackDiv = document.getElementById("aviso-feedback");
            const fileInput = document.getElementById("aviso-foto");
            const file = fileInput.files[0];
            const solicitarDestaque = document.getElementById("aviso-solicitar-destaque").checked;
            
            const dataEventoStr = document.getElementById("aviso-data").value; // CORRIGIDO

            // Valida√ß√µes
            if (solicitarDestaque && !isEditing && !file) {
                feedbackDiv.innerHTML = '<p class="text-red-600 font-semibold">Para solicitar destaque, √© obrigat√≥rio anexar uma imagem.</p>';
                return;
            }
            if (solicitarDestaque && !dataEventoStr) {
                feedbackDiv.innerHTML = '<p class="text-red-600 font-semibold">Para solicitar destaque, a Data e Hora do Evento √© obrigat√≥ria.</p>';
                return;
            }

            // Mostrar loading
            submitButton.querySelector('.button-text').classList.add('hidden');
            submitButton.querySelector('.loading-spinner').classList.remove('hidden');
            submitButton.disabled = true;
            feedbackDiv.innerHTML = `<p class="text-blue-600">${isEditing ? 'Salvando edi√ß√£o...' : 'Publicando aviso...'}</p>`;
            
            try {
                let imageUrl = null;
                
                // 1. Upload da imagem (se houver)
                if (file) {
                    feedbackDiv.innerHTML = '<p class="text-blue-600">Enviando imagem do aviso...</p>';
                    imageUrl = await uploadImageToCloudinary(file);
                }

                // 2. Preparar dados
                const titulo = document.getElementById("aviso-titulo").value;
                const descricao = document.getElementById("aviso-descricao").value;
                
                const dataToUpdate = {
                    titulo: titulo,
                    descricao: descricao,
                    dataPublicacao: Timestamp.now(),
                    dataEvento: dataEventoStr ? Timestamp.fromDate(new Date(dataEventoStr)) : null, // CORRIGIDO
                    statusDestaque: solicitarDestaque ? "pendente" : null
                };
                
                if (imageUrl) {
                    dataToUpdate.imagemUrl = imageUrl;
                }

                // 3. Salvar (Criar novo ou Atualizar existente)
                let avisoId = currentEditingAvisoId;
                if (isEditing) {
                    const avisoDocRef = doc(db, "parishes", currentAdminParish.id, "avisos", currentEditingAvisoId);
                    await updateDoc(avisoDocRef, dataToUpdate);
                } else {
                    const avisoColRef = collection(db, "parishes", currentAdminParish.id, "avisos");
                    const newDoc = await addDoc(avisoColRef, dataToUpdate); // CORRIGIDO: Era avisoData
                    avisoId = newDoc.id; // Pega o ID do novo aviso
                }

                // 4. Enviar para a fila de 'destaqueRequests' (se solicitado)
                if (solicitarDestaque) {
                    feedbackDiv.innerHTML = '<p class="text-blue-600">Enviando pedido de destaque...</p>';
                    
                    // Pega a URL da imagem (seja a nova ou a que j√° existia na edi√ß√£o)
                    let finalImageUrl = imageUrl;
                    if (!finalImageUrl && isEditing) {
                        const avisoDoc = await getDoc(doc(db, "parishes", currentAdminParish.id, "avisos", avisoId));
                        finalImageUrl = avisoDoc.data().imagemUrl || null;
                    }
                    
                    if (!finalImageUrl) {
                         throw new Error("N√£o foi poss√≠vel encontrar uma imagem para o destaque. Por favor, anexe uma imagem ao editar.");
                    }

                    await addDoc(collection(db, "destaqueRequests"), {
                        titulo: titulo,
                        subtitulo: currentAdminParish.nome, // Nome da par√≥quia logada
                        parishId: currentAdminParish.id, // ID da par√≥quia logada
                        avisoId: avisoId, // ID do aviso original
                        dataEvento: Timestamp.fromDate(new Date(dataEventoStr)), // CORRIGIDO
                        imagemUrl: finalImageUrl,
                        status: "pendente" // Status inicial
                    });
                }

                // Sucesso!
                feedbackDiv.innerHTML = `<p class="text-green-600 font-semibold">Aviso ${isEditing ? 'atualizado' : 'publicado'} com sucesso!</p>`;
                resetAvisoForm(); // Reseta o formul√°rio

            } catch (error) {
                console.error("Erro ao publicar aviso:", error);
                feedbackDiv.innerHTML = `<p class="text-red-600 font-semibold">Erro ao publicar: ${error.message}</p>`;
            } finally {
                // Restaurar o bot√£o
                submitButton.querySelector('.button-text').classList.remove('hidden');
                submitButton.querySelector('.loading-spinner').classList.add('hidden');
                submitButton.disabled = false;
            }
        }

        // Fun√ß√£o Gen√©rica de Upload para o Cloudinary
        async function uploadImageToCloudinary(file) {
            // CORRE√á√ÉO FINAL: Garantir que AMBAS as fun√ß√µes usam o nome correto
            const CLOUDINARY_CLOUD_NAME = "dmmij5gpl";
            const CLOUDINARY_UPLOAD_PRESET = "ml_default";

            if (CLOUDINARY_CLOUD_NAME === "COLE_SEU_CLOUD_NAME_AQUI") {
                throw new Error("Cloudinary n√£o configurado.");
            }
            
            const allowedTypes = ['image/jpeg', 'image/png', 'image/webp'];
            if (!allowedTypes.includes(file.type)) {
                throw new Error('Tipo de arquivo n√£o permitido (use JPEG, PNG ou WEBP).');
            }

            const formData = new FormData();
            formData.append("file", file);
            formData.append("upload_preset", CLOUDINARY_UPLOAD_PRESET);
            formData.append("resource_type", "image");

            const uploadResponse = await fetch(`https://api.cloudinary.com/v1_1/${CLOUDINARY_CLOUD_NAME}/image/upload`, {
                method: "POST",
                body: formData
            });

            const text = await uploadResponse.text();
            let uploadResult;
            try { uploadResult = JSON.parse(text); } catch (e) { throw new Error("Resposta inesperada do Cloudinary: " + text); }

            if (!uploadResponse.ok) {
                const errMsg = uploadResult.error?.message || text || "Erro desconhecido no upload.";
                throw new Error("Falha no upload: " + errMsg);
            }

            return uploadResult.secure_url;
        }


        // --- 6.2 L√ìGICA DO SUPER ADMIN ---

        // Renderiza o HTML do Painel de Super Admin
        function showSuperAdminPanel(user) {
            const panel = document.getElementById("admin-panel");
            panel.innerHTML = `
                <div class="bg-white shadow-lg rounded-lg p-6 md:p-8">
                    <div class="flex justify-between items-center mb-6">
                        <div>
                            <h2 class="text-2xl font-bold text-yellow-700">Painel de Administrador</h2>
                            <p class="text-gray-500">Logado como: ${user.email}</p>
                        </div>
                    </div>
                    
                    <h3 class="text-xl font-semibold mb-4">Pedidos de Destaque Pendentes</h3>
                    <div id="requests-loading" class="text-center text-gray-500">Carregando pedidos...</div>
                    <div id="requests-list" class="space-y-4">
                        <!-- Pedidos pendentes ser√£o carregados aqui -->
                    </div>
                </div>
            `;
            
            loadPendingRequests();
        }

        // Carrega os pedidos pendentes
        function loadPendingRequests() {
            const requestsCol = collection(db, "destaqueRequests");
            const q = query(requestsCol, where("status", "==", "pendente"), orderBy("dataEvento", "asc"));

            onSnapshot(q, (snapshot) => {
                try { // Adiciona try para capturar erros de renderiza√ß√£o
                    const listDiv = document.getElementById("requests-list");
                    const loadingDiv = document.getElementById("requests-loading");
                    listDiv.innerHTML = ""; // Limpa a lista

                    if (snapshot.empty) {
                        loadingDiv.innerText = "Nenhum pedido pendente no momento.";
                        return;
                    }
                    
                    loadingDiv.style.display = 'none';

                    snapshot.forEach(doc => {
                        const request = { id: doc.id, ...doc.data() };
                        const dataFormatada = request.dataEvento.toDate().toLocaleDateString('pt-BR', {day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit'});

                        const card = document.createElement('div');
                        card.className = "flex flex-col md:flex-row items-start md:items-center gap-4 p-4 border rounded-lg shadow-sm";
                        card.innerHTML = `
                            <img src="${request.imagemUrl}" alt="${request.titulo}" class="w-full md:w-32 h-32 md:h-20 object-cover rounded-lg">
                            <div class="flex-1">
                                <h4 class="text-lg font-bold">${request.titulo}</h4>
                                <p class="text-sm text-gray-600">${request.subtitulo}</p>
                                <p class="text-sm text-gray-500">Data do Evento: ${dataFormatada}</p>
                            </div>
                            <div class="flex gap-2 w-full md:w-auto">
                                <button class="approve-button w-1/2 md:w-auto bg-green-500 text-white px-3 py-1 rounded-lg hover:bg-green-600" data-id="${request.id}">Aprovar</button>
                                <button class="reject-button w-1/2 md:w-auto bg-red-500 text-white px-3 py-1 rounded-lg hover:bg-red-600" data-id="${request.id}">Rejeitar</button>
                            </div>
                        `;
                        listDiv.appendChild(card);
                    });

                    // Adiciona listeners para os bot√µes de aprovar/rejeitar
                    document.querySelectorAll(".approve-button").forEach(btn => btn.addEventListener('click', handleApproveRequest));
                    document.querySelectorAll(".reject-button").forEach(btn => btn.addEventListener('click', handleRejectRequest));
                } catch (e) {
                    console.error("Erro renderizando pedidos pendentes:", e);
                    document.getElementById("requests-loading").innerText = "Erro ao renderizar pedidos.";
                }
            }, (error) => {
                console.error("Erro ao carregar pedidos:", error);
                document.getElementById("requests-loading").innerText = "Erro ao carregar pedidos.";
            });
        }

        // Fun√ß√£o para Aprovar um pedido
        async function handleApproveRequest(e) {
            const requestId = e.target.dataset.id;
            if (!confirm("Tem certeza que deseja APROVAR este evento? Ele ir√° para a p√°gina inicial.")) return;

            e.target.disabled = true;
            e.target.innerText = "Aprovando...";

            try {
                // 1. Pega os dados do pedido
                const requestDocRef = doc(db, "destaqueRequests", requestId);
                const requestSnap = await getDoc(requestDocRef);
                if (!requestSnap.exists()) throw new Error("Pedido n√£o encontrado.");
                
                const requestData = requestSnap.data();

                // 2. Adiciona √† cole√ß√£o 'destaques' (a cole√ß√£o p√∫blica)
                await addDoc(collection(db, "destaques"), {
                    titulo: requestData.titulo,
                    subtitulo: requestData.subtitulo,
                    imagemUrl: requestData.imagemUrl,
                    dataEvento: requestData.dataEvento,
                    link: requestData.link || null, // Garante que o campo exista
                    parishId: requestData.parishId
                });

                // 3. Atualiza o status do pedido original para 'aprovado'
                await updateDoc(requestDocRef, {
                    status: "aprovado"
                });
                
                // 4. (Opcional) Atualiza o status no aviso original da par√≥quia
                if (requestData.parishId && requestData.avisoId) {
                    await updateDoc(doc(db, "parishes", requestData.parishId, "avisos", requestData.avisoId), {
                        statusDestaque: "aprovado"
                    });
                }

            } catch (error) {
                console.error("Erro ao aprovar:", error);
                alert("Erro ao aprovar pedido: " + error.message);
                e.target.disabled = false;
                e.target.innerText = "Aprovar";
            }
        }

        // Fun√ß√£o para Rejeitar um pedido
        async function handleRejectRequest(e) {
            const requestId = e.target.dataset.id;
            if (!confirm("Tem certeza que deseja REJEITAR este evento?")) return;

            e.target.disabled = true;
            e.target.innerText = "Rejeitando...";

            try {
                // Atualiza o status para 'rejeitado'
                 await updateDoc(doc(db, "destaqueRequests", requestId), {
                    status: "rejeitado"
                });

                // (Opcional) Atualiza o status no aviso original da par√≥quia
                const requestSnap = await getDoc(doc(db, "destaqueRequests", requestId));
                const requestData = requestSnap.data();
                if (requestData.parishId && requestData.avisoId) {
                    await updateDoc(doc(db, "parishes", requestData.parishId, "avisos", requestData.avisoId), {
                        statusDestaque: "rejeitado"
                    });
                }

            } catch (error) {
                console.error("Erro ao rejeitar:", error);
                alert("Erro ao rejeitar pedido: " + error.message);
                e.target.disabled = false;
                e.target.innerText = "Rejeitar";
            }
        }
        
        // Mostra o site p√∫blico (ao deslogar)
        function showPublicSite() {
            if (parishAvisosUnsubscribe) {
                parishAvisosUnsubscribe(); // Desliga o listener de avisos ao sair
                parishAvisosUnsubscribe = null;
            }
            document.getElementById("public-site").style.display = 'block';
            document.getElementById("admin-panel").classList.add("hidden");
            document.getElementById("admin-panel").innerHTML = ""; // Limpa o painel
            document.getElementById("parish-login-button").innerText = 'Acesso Restrito';
            currentAdminParish = null;
            isSuperAdmin = false;
        }

        // --- 7. EVENT LISTENERS (Gatilhos de Intera√ß√£o) ---
        // CORRE√á√ÉO PARA "Script error": Agrupa todos os listeners numa fun√ß√£o
        function initializeAppListeners() {
            // Listener da barra de busca
            document.getElementById("search-input").addEventListener("keyup", filterParishes);

            // Listener de clique nas abas do Mural
            document.querySelectorAll(".tab-button").forEach(button => {
                button.addEventListener("click", () => {
                    const tabId = button.dataset.tab;
                    
                    // Remove 'active' de todos
                    document.querySelectorAll(".tab-button").forEach(btn => btn.classList.remove("active"));
                    document.querySelectorAll(".tab-content").forEach(content => content.classList.remove("active"));

                    // Adiciona 'active' ao clicado
                    button.classList.add("active");
                    document.getElementById(`tab-${tabId}`).classList.add("active");
                });
            });

            // NOVO: Listener de clique nas bolinhas do Carrossel
            // Este listener √© adicionado ao container PAI, uma √∫nica vez.
            // Ele vai "apanhar" os cliques nas bolinhas que s√£o criadas dinamicamente.
            const dotsContainer = document.getElementById("carousel-dots");
            if (dotsContainer) {
                dotsContainer.addEventListener('click', (e) => {
                    const targetDot = e.target.closest('button');
                    if (!targetDot) return;
                    
                    const slideIndex = parseInt(targetDot.dataset.slide);
                    goToSlide(slideIndex);
                    
                    // Reinicia o timer do auto-play
                    if (carouselInterval) clearInterval(carouselInterval);
                    carouselInterval = setInterval(nextSlide, 8000); // 8 segundos
                });
            }

            // Listener para abrir o modal de detalhes (clicando no card da par√≥quia)
            document.getElementById("parishes-list").addEventListener("click", (e) => {
                const card = e.target.closest('[data-parish-id]');
                if (card) {
                    try {
                        showParishDetails(card.dataset.parishId);
                    } catch (error) {
                        console.error("Erro ao tentar mostrar detalhes da par√≥quia:", error);
                        alert("N√£o foi poss√≠vel carregar os detalhes desta par√≥quia.");
                    }
                }
            });

            // Listener para fechar o modal de detalhes
            document.getElementById("parish-modal").addEventListener("click", (e) => {
                // Fecha se clicar no fundo ou no bot√£o "Fechar"
                if (e.target.id === "parish-modal" || e.target.id === "parish-modal-close") {
                    document.getElementById("parish-modal").classList.add("hidden");
                    document.getElementById("parish-modal-content").innerHTML = ""; // Limpa o conte√∫do
                }
            });

            // Listener do bot√£o de Login/Sair
            document.getElementById("parish-login-button").addEventListener("click", () => {
                // Se o usu√°rio estiver logado, o bot√£o agora √© de "Sair"
                if (auth.currentUser) {
                    if (confirm("Tem certeza que deseja sair do painel?")) {
                        signOut(auth);
                    }
                } else {
                    // Se estiver deslogado, abre o modal de login
                    document.getElementById("login-modal").classList.remove("hidden");
                }
            });

            // Listener do modal de login
            document.getElementById("login-cancel-button").addEventListener("click", () => {
                document.getElementById("login-modal").classList.add("hidden");
                document.getElementById("login-error").classList.add("hidden");
                document.getElementById("login-form").reset();
            });

            document.getElementById("login-form").addEventListener("submit", async (e) => {
                e.preventDefault();
                const email = document.getElementById("login-email").value;
                const password = document.getElementById("login-password").value;
                const errorDiv = document.getElementById("login-error");
                const submitButton = document.getElementById("login-submit-button");

                submitButton.querySelector('.button-text').classList.add('hidden');
                submitButton.querySelector('.loading-spinner').classList.remove('hidden');
                submitButton.disabled = true;

                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    // Sucesso! O onAuthStateChanged vai ser disparado
                    document.getElementById("login-modal").classList.add("hidden");
                    errorDiv.classList.add("hidden");
                    document.getElementById("login-form").reset();
                } catch (error) {
                    console.error("Erro de login:", error.code);
                    errorDiv.innerText = "Email ou senha inv√°lidos. Tente novamente.";
                    errorDiv.classList.remove("hidden");
                } finally {
                    submitButton.querySelector('.button-text').classList.remove('hidden');
                    submitButton.querySelector('.loading-spinner').classList.add('hidden');
                    submitButton.disabled = false;
                }
            });

            // Listener de estado de login (o principal)
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // Usu√°rio est√° logado
                    console.log("Usu√°rio logado:", user.uid);
                    document.getElementById("parish-login-button").innerText = 'Sair';
                    document.getElementById("public-site").style.display = 'none';
                    document.getElementById("admin-panel").classList.remove("hidden");
                    try {
                        checkUserRole(user);
                    } catch (error) {
                        console.error("Erro ao verificar fun√ß√£o do usu√°rio:", error);
                        alert("Ocorreu um erro ao verificar suas permiss√µes de usu√°rio.");
                        signOut(auth);
                    }
                } else {
                    // Usu√°rio est√° deslogado
                    console.log("Usu√°rio deslogado.");
                    showPublicSite();
                }
            });
            
            // --- 8. INICIALIZA√á√ÉO DA P√ÅGINA ---
            // Carrega o conte√∫do inicial
            loadGlobalContent();
            loadParishes();
        }

    </script>
</body>
</html>
